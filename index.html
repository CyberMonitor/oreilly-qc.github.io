<!DOCTYPE html>
<html lang="en">
<head>
  <title>Programming Quantum Computers</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
  <script src="./external/ace/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_bitfield.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_reg.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_int.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_basicops.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_widgets.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_staff.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_scriptpanel.js"></script>
<script type="text/javascript" src="https://machinelevel.github.io/QCEngine/src/qcengine_panel.js"></script>

<script type="text/javascript" src="./sample_shortcuts.js"></script>

    <style>
        .panel-resizable {
            resize: vertical;
          overflow: auto;
        }

        .ej-no-margin {
          margin: 0px !important;
/*          margin-bottom:50px !important;
*/           padding: 0px !important;
          padding-bottom:10px !important;
        }

        .xxxpad-left-only {
          margin: 0px !important;
/*           padding: 8px !important;
           padding-left: 10px !important;
           padding-right: 0px !important;
           margin: 0px !important;
           margin-left: 10px;
*/        }
        .xxxpad-right-only {
           padding: 8px !important;
/*           padding-left: 0px !important;
           padding-right: 10px !important;
           margin: 0px !important;
           margin-right: 10px;
*/        }
        .less-padding {
           padding: 0px !important;
           margin: 0px !important;
        }

        .editor {
/*          background-color:#e5e5e5;
          padding:0px;
          margin-top:1%;
          margin-left:1%;
          margin-right:1%;
          margin-bottom:1%;
          float:bottom;
          width:98%;
*/          
/*          resize:vertical;
          overflow:auto;
*/
          overflow: hidden;
          width:100%;
          height:400px;
        }
    </style>

</head>
<body>

<!--
<a href="https://www.amazon.com/Programming-Quantum-Computers-Essential-Algorithms/dp/1492039683">
 -->
<a href="http://shop.oreilly.com/product/0636920167433.do">
  <img src="images/cs-title-bar.jpg" width="100%" />
</a>
<br/>

<div class="row">
  <div class="col-sm-6">
    <div class="container-fluid pad-left-only">

      <div class="panel panel-default">
        <div class="panel-heading">

          <div class="btn-group">
            <button type="button" class="btn btn-success" onclick="handle_run_button();">
                        <span class="glyphicon glyphicon-play"></span>
                        Run Program
            </button>
            <div class="btn-group">


                    <span id="example_choice_span">
              <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
              Choose a sample <span class="caret"></span></button>
              <ul class="dropdown-menu" role="menu">
              </ul>
                    </span>

            </div>
          </div>


          <div class="btn-group">
            <button type="button" class="btn btn-default" onclick="click_editor_zoom(-2);">
              <span class="glyphicon glyphicon-zoom-out"></span>
            </button>
            <button type="button" class="btn btn-default" onclick="click_editor_zoom(2);">
              <span class="glyphicon glyphicon-zoom-in"></span>
            </button>
          </div>

          <span id="example_github_span">
          </span>
        </div>


        <div id="editor_boot_panel" class="panel-body panel-resizable ej-no-margin">
          <div id="editor_div" class="editor"></div>
        </div>
      </div>


    </div>
  </div>
  <div class="col-sm-6">
    <div class="container-fluid pad-right-only">
      <div class="row">
        <div class="col-*-*">
          <div class="container-fluid pad-right-only">
            <div class="panel panel-default">
              <div class="panel-heading">
                <b>Program gates</b>
                <div class="btn-group">
                  <button type="button" class="btn btn-default" onclick="click_gate_zoom(-1);">
                    <span class="glyphicon glyphicon-zoom-out"></span>
                  </button>
                  <button type="button" class="btn btn-default" onclick="click_gate_zoom(1);">
                    <span class="glyphicon glyphicon-zoom-in"></span>
                  </button>
                </div>

<!--                 <button type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-new-window"></span>
                </button>
 -->
              </div>
              <div  id="staff_boot_panel" class="panel-body panel-resizable">



                <div id="staff_popin_div" class="right" style="resize: both; overflow: auto;">
                  <canvas id="draw_gate_canvas"></canvas>
                </div>





              </div>
            </div>
          </div>
        </div>
        <div class="col-*-*">
          <div class="container-fluid pad-right-only">
            <div class="panel panel-default">
              <div class="panel-heading">
                <b>State vector</b>
                <div class="btn-group">
                  <button type="button" class="btn btn-default">
                    <img src="images/circ_style_00a.png" width="64" onclick="click_circle_style(0);"></span>
                  </button>
                  <button type="button" class="btn btn-default">
                    <img src="images/circ_style_01a.png" width="64" onclick="click_circle_style(1);"></span>
                  </button>
                  <button type="button" class="btn btn-default">
                    <img src="images/circ_style_10a.png" width="64" onclick="click_circle_style(2);"></span>
                  </button>
                  <button type="button" class="btn btn-default">
                    <img src="images/circ_style_11a.png" width="64" onclick="click_circle_style(3);"></span>
                  </button>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-zoom-out"></span>
                  </button>
                  <button type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-zoom-in"></span>
                  </button>
                </div>

<!--                 <button type="button" class="btn btn-default">
                    <span class="glyphicon glyphicon-new-window"></span>
                </button>
 -->
              </div>
              <div  id="circle_boot_panel" class="panel-body panel-resizable">

                <div id="circle_div" class="right" style="resize: both; overflow: auto;">
                  <canvas id="circle_canvas"></canvas>
                </div>


              </div>
            </div>



      <div class="panel panel-default">
        <div class="panel-heading">
                <b>Program output</b>

          <div class="btn-group">
            <button type="button" class="btn btn-default" onclick="click_output_zoom(-1);">
              <span class="glyphicon glyphicon-zoom-out"></span>
            </button>
            <button type="button" class="btn btn-default" onclick="click_output_zoom(1);">
              <span class="glyphicon glyphicon-zoom-in"></span>
            </button>
          </div>
        </div>
        <div class="panel-body panel-resizable">
          <textarea id="script_output_textarea" style="font-family:monospace; font-size:12pt; width:100%; height:100px; resize:both;">
(program output goes here)
          </textarea>
        </div>
      </div>




          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    var editor = ace.edit("editor_div");
    editor.session.setMode("ace/mode/javascript");
    editor.commands.addCommand({
        name: "run",
        bindKey: {win: "Shift-Enter", mac: "Shift-Enter"},
        exec: function(editor) {
            handle_run_button();
        }
    });

var editor_div = document.getElementById('editor_div');
var editor_boot_panel = document.getElementById('editor_boot_panel');
var staff_boot_panel = document.getElementById('staff_boot_panel');
var circle_boot_panel = document.getElementById('circle_boot_panel');
var editor_frame_div = document.getElementById('editor_frame_div');
var example_choice_span = document.getElementById('example_choice_span');
var example_github_span = document.getElementById('example_github_span');
// var language_choice_span = document.getElementById('language_choice_span');
var script_output_textarea = document.getElementById('script_output_textarea');
var staff_popin_div = document.getElementById('staff_popin_div');


///////////////////////////////////////////////////////////////
// This is a small workaround for the issue where the editor
// doesn't get informed about size changes
var last_editor_div_width = 0;
var last_editor_div_height = 0;
var last_circle_div_width = 0;
var last_circle_div_height = 0;
var check_serial = 0;
function check_for_editor_resize()
{
    // Editor
    var w = editor_boot_panel.offsetWidth;
    var h = editor_boot_panel.offsetHeight;
    if (w != last_editor_div_width || h != last_editor_div_height)
    {
        editor_div.style.height = "" + (h - 10) + "px";
        editor.resize();
        last_editor_div_width = w;
        last_editor_div_height = h;
    }

    // Circle chart
    var w = circle_boot_panel.offsetWidth;
    var h = circle_boot_panel.offsetHeight;
    if (w != last_circle_div_width || h != last_circle_div_height)
    {
        qc_options.circle_div.width = w;
        qc_options.circle_div.height = h;
        qc.panel_chart.draw();
        last_circle_div_width = w;
        last_circle_div_height = h;
    }

    var seconds_per_check_for_editor_resize = 0.5;
    window.setTimeout(check_for_editor_resize,
                      1000 * seconds_per_check_for_editor_resize);
}

window.onload = function() {
    check_for_editor_resize();
    fetch_sample_contents();
    make_sample_menu();
};

function click_circle_style(style)
{
  if (style == 0)
  {
    qc_options.color_by_phase = false;
    qc_options.book_render = false;
  }
  else if (style == 1)
  {
    qc_options.color_by_phase = false;
    qc_options.book_render = true;
  }
  else if (style == 2)
  {
    qc_options.color_by_phase = true;
    qc_options.book_render = false;
  }
  else if (style == 3)
  {
    qc_options.color_by_phase = true;
    qc_options.book_render = true;
  }
  qc.panel_chart.draw();
}

function click_editor_zoom(up_down)
{
  var editor_fontsize = parseInt(editor.getOption('fontSize'));
  if (up_down == 0)
    editor_fontsize = 12;
  else
    editor_fontsize += up_down;
  if (editor_fontsize < 4)
    editor_fontsize = 4;
  editor.setOptions({fontSize: '' + editor_fontsize + 'pt'});
}

function click_gate_zoom(up_down)
{
  var old_scale = qc.get_param('draw_scale', 1.0);
  var new_scale = 1.0;
  if (up_down == 1)
    new_scale = old_scale * 1.1;
  if (up_down == -1)
    new_scale = old_scale / 1.1;
  qc.set_param('draw_scale', new_scale);
  qc.draw();
}

function click_output_zoom(up_down)
{
  var fontsize = parseInt(script_output_textarea.style.fontSize);
  if (up_down == 0)
    fontsize = 12;
  else
    fontsize += up_down;
  if (fontsize < 4)
    fontsize = 4;
  script_output_textarea.style.fontSize = '' + fontsize + 'pt';
}









function load_json_from_url(file_url)
{
    fetch(file_url, {cache: 'reload'})
      .then(
        function(response) {
          if (response.status !== 200) {
            console.log('Looks like there was a problem. Status Code: ' + response.status);
            return false;
          }

          response.json().then(function(data) {
            console.log(data);
          });
          return true;
        }
      )
      .catch(function(err) {
        console.log('Fetch Error :-S', err);
        return false;
      });
}

function load_code_from_url(file_url)
{
    var use_fetch = false; // fetch is not supported on Kindles
    if (use_fetch)
    {
        fetch(file_url, {cache: 'reload'})
          .then(
            function(response) {
              if (response.status !== 200) {
                console.log('Error loading ' + file_url + '. Status Code: ' + response.status);
                return false;
              }
              response.text().then(function(data) {
                editor.focus();
                editor.setValue(data);
                editor.gotoLine(0);
              });
              return true;
            }
          )
          .catch(function(err) {
            console.log('Fetch Error :-S', err);
            return false;
          });
    }
    else
    {
        var http_request = new XMLHttpRequest();
        http_request.open('GET', file_url, true);

        // If specified, responseType must be empty string or "text"
        http_request.responseType = 'text';

        http_request.onload = function ()
        {
            if (http_request.readyState === http_request.DONE)
            {
                if (http_request.status === 200)
                {
                    // console.log(http_request.response);
                    // console.log(http_request.responseText);
                    editor.focus();
                    editor.setValue(http_request.responseText);
                    editor.gotoLine(0);
                    make_github_source_links();
                }
                else
                {
                  do_failed_load_sample(file_url);
                }
            }
        };
        http_request.onerror = function ()
        {
          do_failed_load_sample(file_url);
        };
        try {
          http_request.send(null);
        }
        catch (error) {
          do_failed_load_sample(file_url);
        }
        return true;
    }
    make_github_source_links();
}

function do_failed_load_sample(file_url)
{
  var code_str = '// The sample ' + file_url + '\n// could not be loaded.\n//\n';
  code_str += '// (basic teleportation sample follows)\n\n';
  code_str += default_program;
  editor.focus();
  editor.setValue(code_str);
  editor.gotoLine(0);
  make_github_source_links();
}

qc_options.staff_canvas = document.getElementById('draw_gate_canvas');
qc_options.staff_div = document.getElementById('staff_popin_div');
qc_options.circle_canvas = document.getElementById('circle_canvas');
qc_options.circle_div = document.getElementById('circle_div');
//qc_options.draw_scale = 3.0;
var qc = QPU();
qc.set_param('draw_scale', 1.0);
// qc.set_canvas(document.getElementById('draw_gate_canvas'));
// panel_staff = qc.panel_staff;
// panel_chart = qc.panel_chart;

var current_sample = null;
var all_sample_contents = {};
function fetch_one_sample_dir(engine)
{
    var base_url = 'https://api.github.com/repos/oreilly-qc/oreilly-qc.github.io/contents/samples/';
    var http_request = new XMLHttpRequest();
    http_request.open('GET', base_url + engine.name, true);

    // If specified, responseType must be empty string or "text"
    http_request.responseType = 'text';

    http_request.onload = function ()
    {
        if (http_request.readyState === http_request.DONE)
        {
            if (http_request.status === 200)
            {
                engine.dir_list = http_request.responseText;
                make_github_source_links();
            }
            else
            {
                engine.dir_list = '';
            }
        }
    };
    http_request.send(null);
}

function fetch_sample_contents()
{
    for (var i = 0; i < engine_list.length; ++i)
        fetch_one_sample_dir(engine_list[i]);
}

function make_sample_menu()
{
    str = '';
    str += '<button id="sample_menu_button" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">';
    str += 'Choose a sample <span class="caret"></span></button>';
    str += '<ul class="dropdown-menu" role="menu">';
    for (i = 0; i < sample_menu.length; ++i)
    {
        sample = sample_menu[i];
        str += '<li><a href="#" onclick="choose_sample_menu(sample_menu['+i+'], null);">';
        str += sample.menu_title;
        str += '</a></li>';
    }
    str += '</ul>'
    example_choice_span.innerHTML = str;
    try_to_get_program_from_passed_in_url();
}

function choose_sample_menu(sample, engine)
{
  console.log('Sample menu chosen: ' + sample.sample_file);
  var sample_menu_button = document.getElementById('sample_menu_button');
  sample_menu_button.innerHTML = sample.menu_title;
  load_code_sample(sample.sample_file);
  clear_output();
}

function make_github_source_links()
{
    var sample = current_sample;
    str = '<br/>';
//    if (sample != null)
    {
        str += 'View source in Github: ';
        for (i = 0; i < engine_list.length; ++i)
        {
            engine = engine_list[i];
            if (i > 0)
                str += ' / ';
            var sample_ok = engine.dir_list.includes(sample.sample_file);
            if (sample_ok)
            {
                var link = 'https://github.com/oreilly-qc/oreilly-qc.github.io/blob/master/samples/';
                link += engine.name + '/' + sample.sample_file + engine.suffix;
                str += '<b><a href="'+link+'">'+engine.name+'</a></b>';
            }
            else
            {
                str += '<span style="color:#aaa">' + engine.name + '</span>';
            }
        }
    }
    example_github_span.innerHTML = str;
}

// get_url_param() is adapted from JeffreyCrofte's work here: https://www.creativejuiz.fr/blog/en/javascript-en/read-url-get-parameters-with-javascript
function get_url_param(param)
{
  var vars = {};
  window.location.href.replace( location.hash, '' ).replace( 
    /[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
    function( m, key, value ) { // callback
      vars[key] = value !== undefined ? value : '';
    }
  );
  if (param) {
    result = vars[param]
    if (!result)
      return null;
    // Strip stray # symbols
    result = result.replace('#','');
    return result;
  }
  return vars;
}

function get_sample_from_string(sample_str)
{
    for (var i = 0; i < sample_menu.length; ++i)
    {
        var sample = sample_menu[i];
        if (sample_str == sample.sample_file || sample_str == sample.shortcut)
            return sample;
    }
    return sample_menu[0];
}

function get_engine_from_string(engine_str)
{
    for (var i = 0; i < engine_list.length; ++i)
    {
        var engine = engine_list[i];
        if (engine_str == engine.sample_file || sample_str == engine.shortcut)
            return engine;
    }
    return engine_list[0];
}

function try_to_get_program_from_passed_in_url()
{
    var sample_str = get_url_param('p');
    var engine_str = get_url_param('e');

    var sample = get_sample_from_string(sample_str);
    var engine = get_engine_from_string(engine_str);
    choose_sample_menu(sample, engine);
}

function load_code_sample(sample_str)
{
    var sample = get_sample_from_string(sample_str);
    current_sample = sample;

    var qce = engine_list[0];
    var raw_qce_code_url = qce.subdir + sample.sample_file + qce.suffix;

    var github_links_str = '';

    ok = load_code_from_url(raw_qce_code_url);
    if (!ok)
    {
        var code_str = '// sample ' + raw_qce_code_url + ' could not be loaded.\n';
        editor.focus();
        editor.setValue(code_str);
        editor.gotoLine(0);
    }
    return ok;
}

// function test_cc(canvas, color)
// {
//     canvas.width = 200;
//     canvas.height = 200;

//     console.log(canvas);
//     var ctx = canvas.getContext('2d');
//     ctx.save();
//     {
//         ctx.fillStyle = color;
//         ctx.fillRect(0, 0, canvas.width, canvas.height);
//     }
//     ctx.restore();
// }

function run_script()
{
    qc_options.color_by_phase = false;
    qc_options.circle_scale = 0.5;
    qc.start();
    if (qc) {
//      qc.disableAnimation();
//      qc.enableRecording();
      qc.codeLabel('');
    }

    qc.enableAnimation();

    runQCScriptInTextArea('editor', 'script_output_textarea');

    qc.qReg.changed();
    show_state_vector();
    qc.panel_staff.draw();
    qc.panel_chart.draw();

    qc.enableAnimation();
}

function clear_output()
{
  script_output_textarea.value = '(output prints here)\n';
}

function rewind_to_beginning()
{
  // if (current_language != 'javascript')
  //   return;
  console.log('instructions: ' + qc.qReg.staff.insertionStart);
  qc.qReg.staff.rewind_insertion_to_start();
}

function show_state_vector()
{
  list = qc.panel_chart.widgets;
  for (var i = 0; i < list.length; ++i)
  {
    if (list[i].stateVector)
    {
      // console.log(list[i]);
      list[i].collapsed = false;
    }
    else if (list[i].blochSphere || list[i].densityMatrix || list[i].graphState || list[i].stabilizerState)
        list[i].in_use = false;
  }
}

function handle_run_button()
{
    run_script();
    qc.panel_staff.setVisible(true);
    qc.panel_chart.setVisible(true);
    qc.panel_staff.staff.fullSnapshot();
}

var default_program = `
// Programming Quantum Computers
//   by Eric Johnston, Nic Harrigan and Mercedes Gimeno-Segovia
//   O'Reilly Media

// To run this online, go to http://oreilly-qc.github.io?p=4-1

// This sample demonstrates basic teleportation.

qc.reset(3);
var alice = qint.new(1, 'alice');
var ep    = qint.new(1, 'ep');
var bob   = qint.new(1, 'bob');

function main()
{
    // This will work with entangle() and alice_prep() in either order.
    // Try swapping them to verify this.
    entangle();
    alice_prep();
    alice_send();
    bob_receive();
    bob_verify();
}

function entangle()
{
    // First, create an entangled pair
    qc.write(0, 2|4);
    qc.label('entangle');
    ep.had();
    bob.cnot(ep);
    qc.label('');
}

function alice_prep()
{
    // Alice prepares her payload to teleport
    alice.write(0);
    qc.label('prep payload');
    alice.had();
    alice.phase(45);
    alice.had();
    qc.label('');
    qc.nop();
}

function alice_send()
{
    // Alice sends the payload (and destroys it in the process)
    qc.label('send');
    ep.cnot(alice);
    alice.had();
    a1 = alice.read();
    a2 = ep.read();
    qc.label('');
    qc.nop();
}

function bob_receive()
{
    // Bob receives the payload, using the two bits Alice sent
    qc.label('receive');
    var bob_is_asleep = false;
    var use_conditonals = true;

    // Option 1: Bob is asleep (can't respond to Alice's data), so he just does whatever.
    if (bob_is_asleep)
    {
        bob.phase(180);
        bob.not();
    }
    // Option 2: Bob is responsive, and we use conditional-ops for visual clarity
    else if (use_conditonals)
    {
        // Here, we use conditional gates, just for visual clarity.
        // The "conditions" are on qubits which have already been read and
        // turned into classical bits.
        bob.cz(alice);
        bob.cnot(ep);
    }
    // Option 3: Bob is responsive, and we use straightforward "if" in the code.
    else
    {
        if (a1)
            bob.phase(180);
        if (a2)
            bob.not();
    }
    qc.label('');
    qc.nop();
}

function bob_verify()
{
    // Verify that the teleportation worked
    qc.label('verify');
    bob.had();
    bob.phase(-45);
    bob.had();
    bob.read();
    qc.label('');
    qc.nop();
}

// Kick it
main();

`;












</script>
</body>
</html>
